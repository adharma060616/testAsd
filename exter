-- Create Database (manual only)
CREATE DATABASE FinEdgeLakeDB;
GO

USE FinEdgeLakeDB;
GO

-- Credential
DROP DATABASE SCOPED CREDENTIAL FinEdgeMI;
GO

CREATE DATABASE SCOPED CREDENTIAL FinEdgeMI
WITH IDENTITY = 'Managed Identity';
GO

-- External Data Source
DROP EXTERNAL DATA SOURCE FinEdgeLake;
GO

CREATE EXTERNAL DATA SOURCE FinEdgeLake
WITH (
    LOCATION = 'abfss://datalake@stgfinedgedatalake.dfs.core.windows.net/',
    CREDENTIAL = FinEdgeMI
);
GO

-- Parquet Format
DROP EXTERNAL FILE FORMAT ParquetFormat;
GO

CREATE EXTERNAL FILE FORMAT ParquetFormat
WITH (FORMAT_TYPE = PARQUET);
GO

##############################

-- Customer Risk
CREATE OR ALTER EXTERNAL TABLE gold_customer_risk
WITH (
  DATA_SOURCE = FinEdgeLake,
  LOCATION = 'gold/customer_risk/',
  FILE_FORMAT = ParquetFormat
)
AS SELECT * FROM OPENROWSET(
  BULK 'gold/customer_risk/*',
  DATA_SOURCE = 'FinEdgeLake',
  FORMAT = 'PARQUET'
) AS rows;
GO

-- Product Performance
CREATE OR ALTER EXTERNAL TABLE gold_product_performance
WITH (DATA_SOURCE = FinEdgeLake, LOCATION = 'gold/product_performance/', FILE_FORMAT = ParquetFormat)
AS SELECT * FROM OPENROWSET(
  BULK 'gold/product_performance/*',
  DATA_SOURCE='FinEdgeLake',
  FORMAT='PARQUET'
) AS rows;
GO

-- Fraud Summary
CREATE OR ALTER EXTERNAL TABLE gold_fraud_summary
WITH (DATA_SOURCE = FinEdgeLake, LOCATION = 'gold/fraud_summary/', FILE_FORMAT = ParquetFormat)
AS SELECT * FROM OPENROWSET(
  BULK 'gold/fraud_summary/*',
  DATA_SOURCE='FinEdgeLake',
  FORMAT='PARQUET'
) AS rows;
GO

-- Monthly Active Customers
CREATE OR ALTER EXTERNAL TABLE gold_monthly_active
WITH (DATA_SOURCE = FinEdgeLake, LOCATION = 'gold/monthly_active/', FILE_FORMAT = ParquetFormat)
AS SELECT * FROM OPENROWSET(
  BULK 'gold/monthly_active/*',
  DATA_SOURCE='FinEdgeLake',
  FORMAT='PARQUET'
) AS rows;
GO

-- Top-100 Risky
CREATE OR ALTER EXTERNAL TABLE gold_top100_risky
WITH (DATA_SOURCE = FinEdgeLake, LOCATION = 'gold/top100_risky/', FILE_FORMAT = ParquetFormat)
AS SELECT * FROM OPENROWSET(
  BULK 'gold/top100_risky/*',
  DATA_SOURCE='FinEdgeLake',
  FORMAT='PARQUET'
) AS rows;
GO


########################


